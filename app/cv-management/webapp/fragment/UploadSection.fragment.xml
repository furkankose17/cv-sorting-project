<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    xmlns:u="sap.ui.unified">

    <VBox class="sapUiSmallMargin">
        <!-- Upload Instructions -->
        <MessageStrip
            text="Upload CVs for automatic processing. Files will be processed with OCR and structured data extraction. Confidence ≥85% will auto-create candidates."
            type="Information"
            showIcon="true"
            class="sapUiMediumMarginBottom" />

        <!-- Auto-create Settings -->
        <HBox alignItems="Center" class="sapUiSmallMarginBottom">
            <Label text="Auto-create Candidates:" class="sapUiTinyMarginEnd" />
            <Switch
                state="{uploadView>/autoCreate}"
                customTextOn="Yes"
                customTextOff="No"
                class="sapUiTinyMarginEnd" />
            <Text text="(Automatically creates candidate if OCR confidence ≥85%)" class="sapUiTinyMarginBegin" />
        </HBox>

        <!-- Upload Area -->
        <Panel
            headerText="Upload CV Documents"
            class="sapUiMediumMarginBottom">
            <VBox alignItems="Center" class="sapUiMediumMargin">

                <!-- File Uploader -->
                <u:FileUploader
                    id="cvFileUploader"
                    name="file"
                    uploadUrl="/api/uploadAndProcessCV"
                    multiple="true"
                    fileType="pdf,png,jpg,jpeg,tiff,doc,docx"
                    mimeType="application/pdf,image/png,image/jpeg,image/tiff,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                    maximumFileSize="10"
                    uploadOnChange="false"
                    change=".onFileSelected"
                    buttonText="Select CV Files..."
                    tooltip="Select one or more CV files to process"
                    width="300px"
                    class="sapUiSmallMarginBottom" />

                <Text
                    text="Supported: PDF, PNG, JPG, TIFF, DOC, DOCX (Max 10MB per file)"
                    class="sapUiTinyMargin" />

                <!-- Selected Files Display -->
                <VBox
                    visible="{= ${uploadView>/selectedFiles}.length > 0}"
                    class="sapUiSmallMarginTop"
                    width="100%">
                    <Label text="Selected Files:" class="sapUiTinyMarginBottom" />
                    <List
                        items="{uploadView>/selectedFiles}"
                        noDataText="No files selected"
                        class="sapUiSmallMarginBottom">
                        <StandardListItem
                            title="{uploadView>name}"
                            description="{uploadView>size}"
                            icon="sap-icon://document" />
                    </List>
                </VBox>

                <!-- Process Button -->
                <Button
                    text="Process CVs"
                    type="Emphasized"
                    icon="sap-icon://begin"
                    press=".onProcessCVs"
                    enabled="{= ${uploadView>/selectedFiles}.length > 0 &amp;&amp; !${uploadView>/processing}}"
                    class="sapUiMediumMarginTop" />

                <!-- Processing Progress -->
                <VBox
                    visible="{uploadView>/processing}"
                    alignItems="Center"
                    class="sapUiMediumMarginTop"
                    width="100%">
                    <ProgressIndicator
                        percentValue="{uploadView>/progress}"
                        displayValue="{uploadView>/progressText}"
                        showValue="true"
                        state="Information"
                        width="100%"
                        class="sapUiSmallMarginBottom" />
                    <Text text="{uploadView>/statusMessage}" />
                </VBox>

                <!-- Success Summary -->
                <MessageStrip
                    text="{uploadView>/resultMessage}"
                    type="{uploadView>/resultType}"
                    showIcon="true"
                    visible="{= ${uploadView>/resultMessage} !== ''}"
                    class="sapUiMediumMarginTop" />

            </VBox>
        </Panel>

        <!-- Recent Uploads -->
        <Panel
            headerText="Recent Uploads"
            expanded="true">
            <Table
                id="recentUploadsTable"
                items="{
                    path: '/CVDocuments',
                    parameters: {
                        $orderby: 'createdAt desc',
                        $expand: 'candidate'
                    }
                }"
                growing="true"
                growingThreshold="10"
                sticky="ColumnHeaders">
                <columns>
                    <Column width="30%">
                        <Text text="File Name" />
                    </Column>
                    <Column width="15%">
                        <Text text="Uploaded" />
                    </Column>
                    <Column width="15%">
                        <Text text="Status" />
                    </Column>
                    <Column width="15%">
                        <Text text="Confidence" />
                    </Column>
                    <Column width="25%">
                        <Text text="Candidate" />
                    </Column>
                </columns>
                <items>
                    <ColumnListItem type="Navigation" press=".onDocumentPress">
                        <cells>
                            <ObjectIdentifier
                                title="{fileName}"
                                text="{mediaType}" />
                            <Text text="{= %{createdAt} ? ${path: 'createdAt', type: 'sap.ui.model.type.DateTime', formatOptions: {pattern: 'dd MMM yyyy HH:mm'}} : '-' }" />
                            <ObjectStatus
                                text="{ocrStatus}"
                                state="{= ${ocrStatus} === 'completed' ? 'Success' : ${ocrStatus} === 'processing' ? 'Information' : ${ocrStatus} === 'failed' ? 'Error' : 'Warning' }" />
                            <Text text="{
                                path: 'ocrConfidence',
                                type: 'sap.ui.model.type.Float',
                                formatOptions: {
                                    maxFractionDigits: 1
                                }
                            }%" />
                            <Text text="{= ${candidate/firstName} ? ${candidate/firstName} + ' ' + ${candidate/lastName} : 'No candidate' }" />
                        </cells>
                        <customData>
                            <core:CustomData key="documentId" value="{ID}" />
                        </customData>
                    </ColumnListItem>
                </items>
            </Table>
        </Panel>
    </VBox>

</core:FragmentDefinition>
