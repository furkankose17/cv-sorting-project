# ============================================
# CV Sorting ML Service - Cloud Foundry Manifest
# Python FastAPI service for OCR, Embeddings, and Matching
# ============================================

applications:
  - name: cv-sorting-ml-service
    # Resource allocation (Sentence Transformers needs memory)
    memory: 2G
    disk_quota: 4G
    instances: 1

    # Python buildpack
    buildpacks:
      - python_buildpack

    # Start command
    command: uvicorn app.main:app --host 0.0.0.0 --port $PORT --workers 2

    # Health check
    health-check-type: http
    health-check-http-endpoint: /health
    timeout: 300  # Longer timeout for model loading

    # Environment variables
    env:
      # ML Model Configuration
      EMBEDDING_MODEL: "all-MiniLM-L12-v2"
      EMBEDDING_DIMENSION: "384"

      # PostgreSQL Connection
      POSTGRES_HOST: "((postgres-host))"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "cv_sorting"
      POSTGRES_USER: "((postgres-user))"
      POSTGRES_PASSWORD: "((postgres-password))"
      POSTGRES_SSL: "true"

      # CAP Service Connection
      CAP_SERVICE_URL: "https://cv-sorting-srv.cfapps.eu10.hana.ondemand.com"
      CAP_CLIENT_ID: "((cap-client-id))"
      CAP_CLIENT_SECRET: "((cap-client-secret))"
      CAP_TOKEN_URL: "((cap-token-url))"

      # OCR Configuration
      TESSERACT_CMD: "/app/.apt/usr/bin/tesseract"
      POPPLER_PATH: "/app/.apt/usr/bin"

      # API Configuration
      API_PREFIX: "/api"
      DEBUG: "false"
      LOG_LEVEL: "INFO"

      # Rate Limiting
      RATE_LIMIT_REQUESTS: "100"
      RATE_LIMIT_WINDOW: "60"

      # CORS
      ALLOWED_ORIGINS: "https://cv-sorting-srv.cfapps.eu10.hana.ondemand.com,https://cv-sorting-n8n.cfapps.eu10.hana.ondemand.com"

    # Routes
    routes:
      - route: cv-sorting-ml.cfapps.eu10.hana.ondemand.com

    # Service bindings
    services:
      - cv-sorting-postgresql

# ============================================
# Apt buildpack configuration for Tesseract
# Create an Aptfile in the root with:
#   tesseract-ocr
#   tesseract-ocr-eng
#   tesseract-ocr-deu
#   tesseract-ocr-tur
#   poppler-utils
#   libpoppler-cpp-dev
# ============================================
